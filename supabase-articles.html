<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ç« ç®¡ç† - Supabaseç‰ˆæœ¬</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="articles.css">
    <script src="auth-check.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-logo">ğŸ“ Supabaseæ–‡ç« ç®¡ç†</h1>
            <ul class="nav-menu">
                <li><a href="index.html">ğŸ  è¿”å›é¦–é¡µ</a></li>
                <li><a href="#" onclick="logout()">ğŸšª é€€å‡º</a></li>
            </ul>
        </div>
    </nav>

    <main class="articles-main">
        <div class="container">
            <div class="articles-header">
                <div class="header-content">
                    <h1>ğŸ“š æ–‡ç« ç®¡ç†ç³»ç»Ÿ</h1>
                    <p class="subtitle">åŸºäºSupabaseå®æ—¶æ•°æ®åº“ â€¢ æ”¯æŒå¤šäººåä½œ</p>
                </div>
                <button onclick="createNewArticle()" class="new-article-btn" id="newArticleBtn">
                    â• æ–°å»ºæ–‡ç« 
                </button>
            </div>

            <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <div id="connectionStatus" class="connection-status">
                <span>ğŸ”„ æ­£åœ¨è¿æ¥Supabase...</span>
            </div>

            <!-- åŠŸèƒ½è¯´æ˜ -->
            <div class="features-info">
                <div class="feature-item">
                    <span class="feature-icon">âš¡</span>
                    <span>å®æ—¶åŒæ­¥</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">ğŸ‘¥</span>
                    <span>å¤šäººåä½œ</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">â˜ï¸</span>
                    <span>äº‘ç«¯å­˜å‚¨</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">ğŸ”’</span>
                    <span>æƒé™ç®¡ç†</span>
                </div>
            </div>

            <!-- æ–‡ç« åˆ—è¡¨ -->
            <div class="articles-list" id="articlesList">
                <div class="loading-articles">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨ä»SupabaseåŠ è½½æ–‡ç« ...</p>
                </div>
            </div>

            <!-- æ–‡ç« ç¼–è¾‘å™¨ -->
            <div id="articleEditor" class="article-editor hidden">
                <div class="editor-header">
                    <div class="editor-title-section">
                        <input type="text" id="articleTitle" placeholder="è¾“å…¥æ–‡ç« æ ‡é¢˜..." maxlength="100">
                        <div class="title-counter">
                            <span id="titleCounter">0/100</span>
                        </div>
                    </div>
                    <div class="editor-actions">
                        <button onclick="saveArticle()" class="save-btn" id="saveBtn">
                            ğŸ’¾ ä¿å­˜åˆ°äº‘ç«¯
                        </button>
                        <button onclick="closeEditor()" class="close-btn">
                            âŒ å…³é—­
                        </button>
                    </div>
                </div>
                
                <div class="editor-body">
                    <textarea id="articleContent" 
                              placeholder="å¼€å§‹å†™ä½œ...&#10;&#10;ğŸ’¡ ç¼–å†™æŠ€å·§ï¼š&#10;â€¢ ä½¿ç”¨æ¸…æ™°çš„æ®µè½ç»“æ„&#10;â€¢ æ”¯æŒCtrl+Så¿«æ·ä¿å­˜&#10;â€¢ å†…å®¹ä¼šè‡ªåŠ¨ä¿å­˜åˆ°Supabaseäº‘ç«¯&#10;â€¢ å…¶ä»–ç”¨æˆ·å¯ä»¥å®æ—¶çœ‹åˆ°ä½ çš„æ›´æ–°"></textarea>
                    
                    <div class="editor-toolbar">
                        <div class="word-count">
                            <span>å­—æ•°ï¼š</span>
                            <span id="wordCount">0</span>
                        </div>
                        <div class="editor-shortcuts">
                            <span>ğŸ’¡ Ctrl+Sä¿å­˜ | Escå…³é—­</span>
                        </div>
                    </div>
                </div>
                
                <div class="editor-info">
                    <span id="editorInfo">Supabaseå®æ—¶ç¼–è¾‘å™¨</span>
                    <div class="save-status">
                        <span id="saveStatus"></span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- æ·»åŠ æ ·å¼ -->
    <style>
        .articles-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .header-content h1 {
            margin: 0 0 5px 0;
            color: #2c3e50;
        }

        .subtitle {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .features-info {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #555;
        }

        .feature-icon {
            font-size: 16px;
        }

        .connection-status {
            margin-bottom: 20px;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .connection-status.success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border-color: #c3e6cb;
        }

        .connection-status.error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border-color: #f5c6cb;
        }

        .editor-title-section {
            flex: 1;
            position: relative;
        }

        .title-counter {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #999;
        }

        .editor-body {
            position: relative;
        }

        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
            font-size: 12px;
            color: #666;
        }

        .word-count {
            display: flex;
            gap: 5px;
        }

        .save-status {
            font-size: 12px;
            color: #666;
        }

        .loading-articles {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        @media (max-width: 768px) {
            .articles-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .features-info {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .editor-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .editor-title-section {
                width: 100%;
            }
        }
    </style>

    <!-- Supabaseé…ç½®å’Œæ–‡ç« ç®¡ç† -->
    <script type="module">
        import { supabase } from './supabase-config.js';
        
        // è®¾ç½®å…¨å±€å˜é‡
        window.supabase = supabase;
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–Supabaseæ–‡ç« ç®¡ç†');
            
            // å»¶è¿ŸåŠ è½½ç¡®ä¿æ‰€æœ‰ä¾èµ–å°±ç»ª
            setTimeout(async () => {
                try {
                    // åŠ è½½æ–‡ç« ç®¡ç†æ¨¡å—
                    await import('./supabase-articles.js');
                    
                    // åˆå§‹åŒ–æ–‡ç« ç®¡ç†
                    if (window.initSupabaseArticles) {
                        await window.initSupabaseArticles();
                    }
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    updateConnectionStatus('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                }
            }, 1000);
        });
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(message, type) {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.innerHTML = message;
                statusElement.className = `connection-status ${type}`;
            }
        }
        
        // è®¾ä¸ºå…¨å±€å‡½æ•°
        window.updateConnectionStatus = updateConnectionStatus;
    </script>

    <!-- ä¼ ç»Ÿæ–‡ç« ç®¡ç†ä½œä¸ºåå¤‡ -->
    <script src="articles.js"></script>

    <!-- ç¼–è¾‘å™¨åŠŸèƒ½å¢å¼º -->
    <script>
        // æ ‡é¢˜å­—æ•°ç»Ÿè®¡
        document.addEventListener('DOMContentLoaded', function() {
            const titleInput = document.getElementById('articleTitle');
            const titleCounter = document.getElementById('titleCounter');
            const contentTextarea = document.getElementById('articleContent');
            const wordCount = document.getElementById('wordCount');
            
            if (titleInput && titleCounter) {
                titleInput.addEventListener('input', function() {
                    const length = this.value.length;
                    titleCounter.textContent = `${length}/100`;
                    
                    if (length > 90) {
                        titleCounter.style.color = '#e74c3c';
                    } else if (length > 70) {
                        titleCounter.style.color = '#f39c12';
                    } else {
                        titleCounter.style.color = '#999';
                    }
                });
            }
            
            // å†…å®¹å­—æ•°ç»Ÿè®¡
            if (contentTextarea && wordCount) {
                contentTextarea.addEventListener('input', function() {
                    const text = this.value;
                    const count = text.length;
                    wordCount.textContent = count.toLocaleString();
                });
            }
        });
        
        // åˆ›å»ºæ–°æ–‡ç« 
        function createNewArticle() {
            if (!hasPermission('edit')) {
                alert('æ‚¨æ²¡æœ‰ç¼–è¾‘æƒé™');
                return;
            }
            
            window.currentEditingId = null;
            document.getElementById('articleTitle').value = '';
            document.getElementById('articleContent').value = '';
            document.getElementById('editorInfo').textContent = 'æ­£åœ¨åˆ›å»ºæ–°æ–‡ç« ...';
            document.getElementById('saveStatus').textContent = '';
            document.getElementById('articleEditor').classList.remove('hidden');
            document.getElementById('articleTitle').focus();
            
            // é‡ç½®è®¡æ•°å™¨
            document.getElementById('titleCounter').textContent = '0/100';
            document.getElementById('wordCount').textContent = '0';
        }
        
        // ä¿å­˜æ–‡ç« 
        function saveArticle() {
            const title = document.getElementById('articleTitle').value.trim();
            const content = document.getElementById('articleContent').value.trim();
            
            if (!title || !content) {
                alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
                return;
            }
            
            // æ˜¾ç¤ºä¿å­˜çŠ¶æ€
            const saveStatus = document.getElementById('saveStatus');
            const saveBtn = document.getElementById('saveBtn');
            
            saveStatus.textContent = 'æ­£åœ¨ä¿å­˜...';
            saveBtn.disabled = true;
            saveBtn.textContent = 'â³ ä¿å­˜ä¸­...';
            
            // ä½¿ç”¨Supabaseä¿å­˜
            if (window.saveArticleToSupabase) {
                window.saveArticleToSupabase(title, content).finally(() => {
                    saveStatus.textContent = '';
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'ğŸ’¾ ä¿å­˜åˆ°äº‘ç«¯';
                });
            } else {
                // åå¤‡æ–¹æ¡ˆ
                setTimeout(() => {
                    saveStatus.textContent = '';
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'ğŸ’¾ ä¿å­˜åˆ°äº‘ç«¯';
                    alert('ä¿å­˜åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨');
                }, 1000);
            }
        }
        
        // å…³é—­ç¼–è¾‘å™¨
        function closeEditor() {
            document.getElementById('articleEditor').classList.add('hidden');
            window.currentEditingId = null;
        }
        
        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (!document.getElementById('articleEditor').classList.contains('hidden')) {
                    saveArticle();
                }
            }
            
            if (e.key === 'Escape') {
                if (!document.getElementById('articleEditor').classList.contains('hidden')) {
                    closeEditor();
                }
            }
        });
    </script>
</body>
</html>
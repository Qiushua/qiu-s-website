<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章管理 - Supabase版本</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="articles.css">
    <script src="auth-check.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-logo">📝 Supabase文章管理</h1>
            <ul class="nav-menu">
                <li><a href="index.html">🏠 返回首页</a></li>
                <li><a href="#" onclick="logout()">🚪 退出</a></li>
            </ul>
        </div>
    </nav>

    <main class="articles-main">
        <div class="container">
            <div class="articles-header">
                <div class="header-content">
                    <h1>📚 文章管理系统</h1>
                    <p class="subtitle">基于Supabase实时数据库 • 支持多人协作</p>
                </div>
                <button onclick="createNewArticle()" class="new-article-btn" id="newArticleBtn">
                    ➕ 新建文章
                </button>
            </div>

            <!-- 连接状态指示器 -->
            <div id="connectionStatus" class="connection-status">
                <span>🔄 正在连接Supabase...</span>
            </div>

            <!-- 功能说明 -->
            <div class="features-info">
                <div class="feature-item">
                    <span class="feature-icon">⚡</span>
                    <span>实时同步</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">👥</span>
                    <span>多人协作</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">☁️</span>
                    <span>云端存储</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">🔒</span>
                    <span>权限管理</span>
                </div>
            </div>

            <!-- 文章列表 -->
            <div class="articles-list" id="articlesList">
                <div class="loading-articles">
                    <div class="spinner"></div>
                    <p>正在从Supabase加载文章...</p>
                </div>
            </div>

            <!-- 文章编辑器 -->
            <div id="articleEditor" class="article-editor hidden">
                <div class="editor-header">
                    <div class="editor-title-section">
                        <input type="text" id="articleTitle" placeholder="输入文章标题..." maxlength="100">
                        <div class="title-counter">
                            <span id="titleCounter">0/100</span>
                        </div>
                    </div>
                    <div class="editor-actions">
                        <button onclick="saveArticle()" class="save-btn" id="saveBtn">
                            💾 保存到云端
                        </button>
                        <button onclick="closeEditor()" class="close-btn">
                            ❌ 关闭
                        </button>
                    </div>
                </div>
                
                <div class="editor-body">
                    <textarea id="articleContent" 
                              placeholder="开始写作...&#10;&#10;💡 编写技巧：&#10;• 使用清晰的段落结构&#10;• 支持Ctrl+S快捷保存&#10;• 内容会自动保存到Supabase云端&#10;• 其他用户可以实时看到你的更新"></textarea>
                    
                    <div class="editor-toolbar">
                        <div class="word-count">
                            <span>字数：</span>
                            <span id="wordCount">0</span>
                        </div>
                        <div class="editor-shortcuts">
                            <span>💡 Ctrl+S保存 | Esc关闭</span>
                        </div>
                    </div>
                </div>
                
                <div class="editor-info">
                    <span id="editorInfo">Supabase实时编辑器</span>
                    <div class="save-status">
                        <span id="saveStatus"></span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 添加样式 -->
    <style>
        .articles-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .header-content h1 {
            margin: 0 0 5px 0;
            color: #2c3e50;
        }

        .subtitle {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .features-info {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #555;
        }

        .feature-icon {
            font-size: 16px;
        }

        .connection-status {
            margin-bottom: 20px;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .connection-status.success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border-color: #c3e6cb;
        }

        .connection-status.error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border-color: #f5c6cb;
        }

        .editor-title-section {
            flex: 1;
            position: relative;
        }

        .title-counter {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #999;
        }

        .editor-body {
            position: relative;
        }

        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
            font-size: 12px;
            color: #666;
        }

        .word-count {
            display: flex;
            gap: 5px;
        }

        .save-status {
            font-size: 12px;
            color: #666;
        }

        .loading-articles {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        @media (max-width: 768px) {
            .articles-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .features-info {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .editor-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .editor-title-section {
                width: 100%;
            }
        }
    </style>

    <!-- Supabase配置和文章管理 -->
    <script type="module">
        import { supabase } from './supabase-config.js';
        
        // 设置全局变量
        window.supabase = supabase;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('页面加载完成，初始化Supabase文章管理');
            
            // 延迟加载确保所有依赖就绪
            setTimeout(async () => {
                try {
                    // 加载文章管理模块
                    await import('./supabase-articles.js');
                    
                    // 初始化文章管理
                    if (window.initSupabaseArticles) {
                        await window.initSupabaseArticles();
                    }
                } catch (error) {
                    console.error('初始化失败:', error);
                    updateConnectionStatus('❌ 初始化失败: ' + error.message, 'error');
                }
            }, 1000);
        });
        
        // 更新连接状态
        function updateConnectionStatus(message, type) {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.innerHTML = message;
                statusElement.className = `connection-status ${type}`;
            }
        }
        
        // 设为全局函数
        window.updateConnectionStatus = updateConnectionStatus;
    </script>

    <!-- 传统文章管理作为后备 -->
    <script src="articles.js"></script>

    <!-- 编辑器功能增强 -->
    <script>
        // 标题字数统计
        document.addEventListener('DOMContentLoaded', function() {
            const titleInput = document.getElementById('articleTitle');
            const titleCounter = document.getElementById('titleCounter');
            const contentTextarea = document.getElementById('articleContent');
            const wordCount = document.getElementById('wordCount');
            
            if (titleInput && titleCounter) {
                titleInput.addEventListener('input', function() {
                    const length = this.value.length;
                    titleCounter.textContent = `${length}/100`;
                    
                    if (length > 90) {
                        titleCounter.style.color = '#e74c3c';
                    } else if (length > 70) {
                        titleCounter.style.color = '#f39c12';
                    } else {
                        titleCounter.style.color = '#999';
                    }
                });
            }
            
            // 内容字数统计
            if (contentTextarea && wordCount) {
                contentTextarea.addEventListener('input', function() {
                    const text = this.value;
                    const count = text.length;
                    wordCount.textContent = count.toLocaleString();
                });
            }
        });
        
        // 创建新文章
        function createNewArticle() {
            if (!hasPermission('edit')) {
                alert('您没有编辑权限');
                return;
            }
            
            window.currentEditingId = null;
            document.getElementById('articleTitle').value = '';
            document.getElementById('articleContent').value = '';
            document.getElementById('editorInfo').textContent = '正在创建新文章...';
            document.getElementById('saveStatus').textContent = '';
            document.getElementById('articleEditor').classList.remove('hidden');
            document.getElementById('articleTitle').focus();
            
            // 重置计数器
            document.getElementById('titleCounter').textContent = '0/100';
            document.getElementById('wordCount').textContent = '0';
        }
        
        // 保存文章
        function saveArticle() {
            const title = document.getElementById('articleTitle').value.trim();
            const content = document.getElementById('articleContent').value.trim();
            
            if (!title || !content) {
                alert('请填写标题和内容');
                return;
            }
            
            // 显示保存状态
            const saveStatus = document.getElementById('saveStatus');
            const saveBtn = document.getElementById('saveBtn');
            
            saveStatus.textContent = '正在保存...';
            saveBtn.disabled = true;
            saveBtn.textContent = '⏳ 保存中...';
            
            // 使用Supabase保存
            if (window.saveArticleToSupabase) {
                window.saveArticleToSupabase(title, content).finally(() => {
                    saveStatus.textContent = '';
                    saveBtn.disabled = false;
                    saveBtn.textContent = '💾 保存到云端';
                });
            } else {
                // 后备方案
                setTimeout(() => {
                    saveStatus.textContent = '';
                    saveBtn.disabled = false;
                    saveBtn.textContent = '💾 保存到云端';
                    alert('保存功能暂时不可用');
                }, 1000);
            }
        }
        
        // 关闭编辑器
        function closeEditor() {
            document.getElementById('articleEditor').classList.add('hidden');
            window.currentEditingId = null;
        }
        
        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (!document.getElementById('articleEditor').classList.contains('hidden')) {
                    saveArticle();
                }
            }
            
            if (e.key === 'Escape') {
                if (!document.getElementById('articleEditor').classList.contains('hidden')) {
                    closeEditor();
                }
            }
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章管理系统</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="articles.css">
    <script src="auth-check.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-logo">📝 文章管理系统</h1>
            <ul class="nav-menu">
                <li><a href="index.html">🏠 返回首页</a></li>
                <li><a href="#" onclick="logout()">🚪 退出登录</a></li>
            </ul>
        </div>
    </nav>

    <main class="articles-main">
        <div class="container">
            <!-- 页面头部 -->
            <div class="page-header">
                <div class="header-content">
                    <h1>📚 文章管理中心</h1>
                    <p class="subtitle">基于Supabase实时数据库 • 支持多人协作编辑</p>
                </div>
                <button onclick="createNewArticle()" class="new-article-btn" id="newArticleBtn">
                    ➕ 创建新文章
                </button>
            </div>

            <!-- 系统状态 -->
            <div id="systemStatus" class="system-status">
                <div class="status-item">
                    <span class="status-icon">🔄</span>
                    <span class="status-text">正在连接Supabase...</span>
                </div>
            </div>

            <!-- 功能特性展示 -->
            <div class="features-banner">
                <div class="feature-item">
                    <span class="feature-icon">⚡</span>
                    <div class="feature-text">
                        <strong>实时同步</strong>
                        <span>多人编辑即时更新</span>
                    </div>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">🔒</span>
                    <div class="feature-text">
                        <strong>权限控制</strong>
                        <span>安全的访问管理</span>
                    </div>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">☁️</span>
                    <div class="feature-text">
                        <strong>云端存储</strong>
                        <span>数据永不丢失</span>
                    </div>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">📱</span>
                    <div class="feature-text">
                        <strong>响应式设计</strong>
                        <span>完美支持移动设备</span>
                    </div>
                </div>
            </div>

            <!-- 文章统计 -->
            <div id="articlesStats" class="articles-stats hidden">
                <div class="stat-card">
                    <div class="stat-number" id="totalArticles">0</div>
                    <div class="stat-label">总文章数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="myArticles">0</div>
                    <div class="stat-label">我的文章</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayArticles">0</div>
                    <div class="stat-label">今日新增</div>
                </div>
            </div>

            <!-- 文章列表 -->
            <div class="articles-section">
                <div class="section-header">
                    <h2>📄 文章列表</h2>
                    <div class="articles-controls">
                        <select id="sortOrder" onchange="handleSortChange()">
                            <option value="newest">最新发布</option>
                            <option value="oldest">最早发布</option>
                            <option value="updated">最近更新</option>
                            <option value="title">按标题排序</option>
                        </select>
                        <button onclick="refreshArticles()" class="refresh-btn" title="刷新列表">
                            🔄
                        </button>
                    </div>
                </div>
                
                <div id="articlesList" class="articles-list">
                    <div class="loading-placeholder">
                        <div class="loading-spinner"></div>
                        <p>正在从Supabase加载文章...</p>
                        <p class="loading-tip">首次加载可能需要几秒钟</p>
                    </div>
                </div>
            </div>

            <!-- 文章编辑器 -->
            <div id="articleEditor" class="article-editor hidden">
                <div class="editor-header">
                    <div class="editor-title-section">
                        <input type="text" 
                               id="articleTitle" 
                               placeholder="请输入文章标题..." 
                               maxlength="100"
                               autocomplete="off">
                        <div class="title-info">
                            <span id="titleCounter" class="counter">0/100</span>
                        </div>
                    </div>
                    <div class="editor-actions">
                        <button onclick="saveArticle()" class="save-btn" id="saveBtn">
                            💾 保存文章
                        </button>
                        <button onclick="previewArticle()" class="preview-btn" id="previewBtn">
                            👁️ 预览
                        </button>
                        <button onclick="closeEditor()" class="close-btn">
                            ❌ 关闭
                        </button>
                    </div>
                </div>
                
                <div class="editor-body">
                    <div class="editor-toolbar">
                        <div class="toolbar-group">
                            <button onclick="insertText('**', '**')" title="粗体" class="toolbar-btn">
                                <strong>B</strong>
                            </button>
                            <button onclick="insertText('*', '*')" title="斜体" class="toolbar-btn">
                                <em>I</em>
                            </button>
                            <button onclick="insertText('`', '`')" title="代码" class="toolbar-btn">
                                &lt;/&gt;
                            </button>
                        </div>
                        <div class="toolbar-group">
                            <button onclick="insertText('## ', '')" title="标题" class="toolbar-btn">
                                H2
                            </button>
                            <button onclick="insertText('- ', '')" title="列表" class="toolbar-btn">
                                ≡
                            </button>
                            <button onclick="insertText('> ', '')" title="引用" class="toolbar-btn">
                                "
                            </button>
                        </div>
                    </div>
                    
                    <textarea id="articleContent" 
                              placeholder="开始编写您的文章内容...&#10;&#10;💡 编写提示：&#10;• 支持Markdown格式&#10;• Ctrl+S 快速保存&#10;• Ctrl+Enter 发布文章&#10;• 内容会自动保存到云端&#10;• 支持实时协作编辑"></textarea>
                </div>
                
                <div class="editor-footer">
                    <div class="editor-info">
                        <span id="editorStatus">就绪</span>
                        <span class="separator">•</span>
                        <span id="wordCount">0 字</span>
                        <span class="separator">•</span>
                        <span id="saveTime">未保存</span>
                    </div>
                    <div class="editor-shortcuts">
                        <span>💡 快捷键：Ctrl+S保存 | Ctrl+Enter发布 | Esc关闭</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 文章预览模态框 -->
    <div id="previewModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📖 文章预览</h3>
                <button onclick="closePreview()" class="modal-close">❌</button>
            </div>
            <div class="modal-body">
                <div id="previewContent" class="preview-content"></div>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div id="deleteModal" class="modal hidden">
        <div class="modal-content small">
            <div class="modal-header">
                <h3>⚠️ 确认删除</h3>
            </div>
            <div class="modal-body">
                <p>您确定要删除这篇文章吗？</p>
                <p class="warning-text">此操作无法撤销！</p>
                <div class="modal-actions">
                    <button onclick="confirmDelete()" class="delete-confirm-btn">
                        🗑️ 确认删除
                    </button>
                    <button onclick="cancelDelete()" class="cancel-btn">
                        ↩️ 取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase和文章管理脚本 -->
    <script type="module">
        import { supabase } from './supabase-config.js';
        
        // 设置全局变量
        window.supabase = supabase;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('📝 文章管理页面开始初始化...');
            
            // 延迟加载确保所有依赖就绪
            setTimeout(async () => {
                try {
                    // 动态加载文章管理模块
                    const articlesModule = await import('./supabase-articles.js');
                    
                    // 初始化文章管理系统
                    if (window.initArticleSystem) {
                        await window.initArticleSystem();
                    } else {
                        console.error('文章管理系统初始化函数未找到');
                    }
                } catch (error) {
                    console.error('初始化文章管理系统失败:', error);
                    updateSystemStatus('❌ 系统初始化失败: ' + error.message, 'error');
                }
            }, 1000);
        });
        
        // 更新系统状态
        function updateSystemStatus(message, type = 'info') {
            const statusElement = document.getElementById('systemStatus');
            if (statusElement) {
                const statusItem = statusElement.querySelector('.status-item');
                const statusIcon = statusItem.querySelector('.status-icon');
                const statusText = statusItem.querySelector('.status-text');
                
                statusText.textContent = message;
                
                // 更新图标和样式
                if (type === 'success') {
                    statusIcon.textContent = '✅';
                    statusElement.className = 'system-status success';
                } else if (type === 'error') {
                    statusIcon.textContent = '❌';
                    statusElement.className = 'system-status error';
                } else {
                    statusIcon.textContent = '🔄';
                    statusElement.className = 'system-status loading';
                }
                
                // 成功状态3秒后隐藏
                if (type === 'success') {
                    setTimeout(() => {
                        statusElement.style.display = 'none';
                    }, 3000);
                }
            }
        }
        
        // 设为全局函数
        window.updateSystemStatus = updateSystemStatus;
    </script>
</body>
</html>